# item79. ê³¼ë„í•œ ë™ê¸°í™”ëŠ” í”¼í•˜ë¼

### ğŸ™…â€â™‚ï¸ì‘ë‹µ ë¶ˆê°€ì™€ ì•ˆì „ ì‹¤íŒ¨ë¥¼ í”¼í•˜ë ¤ë©´ ë™ê¸°í™” ë©”ì„œë“œë‚˜ ë™ê¸°í™” ë¸”ë¡ ì•ˆì—ì„œëŠ” ì œì–´ë¥¼ ì ˆëŒ€ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì–‘ë„í•˜ë©´ ì•ˆëœë‹¤!

## ë™ê¸°í™”(Synchronize)

"ì—¬ëŸ¬ê°œì˜ ì“°ë ˆë“œê°€ í•œ ê°œì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•˜ë ¤ê³  í•  ë•Œ ,

ì‚¬ìš© í•˜ë ¤ëŠ” ì“°ë ˆë“œë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ë“¤ì´ ì ‘ê·¼í•˜ì§€ ëª»í•˜ê²Œ ë§‰ëŠ”ê²ƒ"

â†’ Thread-safe

ë™ê¸°í™” ë°©ë²•

- ë©”ì†Œë“œ ìì²´ Synchronizedë¡œ ì„ ì–¸í•˜ëŠ” ë°©ë²•
- ë¸”ë¡ìœ¼ë¡œ ê°ì²´ë¥¼ ë°›ì•„ lockì„ ê±°ëŠ” ë°©ë²• - syncrhonized(this)

### ë©€í‹°ìŠ¤ë ˆë“œ í”„ë¡œì„¸ìŠ¤ëŠ”Â ë™ì‹œì„±Â ë˜ëŠ”Â ë³‘ë ¬ì„±ìœ¼ë¡œ ì‹¤í–‰ëœë‹¤.

ë™ì‹œì„± : í•˜ë‚˜ì˜ ì½”ì–´ì—ì„œ ì—¬ëŸ¬ê°œì˜ í”„ë¡œì„¸ìŠ¤ê°€ ë²ˆê°ˆì•„ ê°€ë©´ì„œ ì‹¤í–‰ë¨

ë³‘ë ¬ì„± : ë©€í‹° ì½”ì–´ì—ì„œ ê°œë³„ ìŠ¤ë ˆë“œë¥¼ ë™ì‹œì— ì‹¤í–‰

## êµì°© ìƒíƒœ

í•œì •ëœ ìì›ì„ ì—¬ëŸ¬ ê³³ì—ì„œ ì‚¬ìš©í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” í˜„ìƒ

![item79%20%E1%84%80%E1%85%AA%E1%84%83%E1%85%A9%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%83%E1%85%A9%E1%86%BC%E1%84%80%E1%85%B5%E1%84%92%E1%85%AA%E1%84%82%E1%85%B3%E1%86%AB%20%E1%84%91%E1%85%B5%E1%84%92%E1%85%A1%E1%84%85%E1%85%A1%20e37b2138b4704c21a9d60101526477fe/deadlock.png](item79%20%E1%84%80%E1%85%AA%E1%84%83%E1%85%A9%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%83%E1%85%A9%E1%86%BC%E1%84%80%E1%85%B5%E1%84%92%E1%85%AA%E1%84%82%E1%85%B3%E1%86%AB%20%E1%84%91%E1%85%B5%E1%84%92%E1%85%A1%E1%84%85%E1%85%A1%20e37b2138b4704c21a9d60101526477fe/deadlock.png)

ì¶œì²˜ : [https://www.geeksforgeeks.org/deadlock-in-java-multithreading/](https://www.geeksforgeeks.org/deadlock-in-java-multithreading/)

ğŸ’¡ì£¼ì˜

- ë™ê¸°í™”(synchronized) ëœ ì½”ë“œ ë¸”ëŸ­ ì•ˆì—ì„œëŠ” ì¬ì •ì˜ ê°€ëŠ¥í•œ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ì„  ì•ˆëœë‹¤.
- í´ë¼ì´ì–¸íŠ¸ê°€ ë„˜ê²¨ì¤€ í•¨ìˆ˜ê°ì²´ë¥¼ í˜¸ì¶œí•´ì„œë„ ì•ˆëœë‹¤.
- ì´ëŸ° ë©”ì„œë“œëŠ” ë™ê¸°í™”ë„ë‹ˆ í´ë˜ìŠ¤ ê´€ì ì—ì„œ ì™¸ê³„ì¸ ë©”ì„œë“œ(alien method)ë¼ê³  ì¹­í•œë‹¤.(ë¬´ìŠ¨ì¼ì„ í• ì§€ ëª¨ë¥´ë‹ˆ, ì´ ë©”ì„œë“œê°€ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¤ê±°ë‚˜, êµì°©ìƒíƒœë¥¼ ë§Œë“¤ê±°ë‚˜, ë°ì´í„°ë¥¼ í›¼ì†ì‹œí‚¬ ìˆ˜ ìˆë‹¤.)

---

case 1) ConcurrentModificationExcption ì´ ë°œìƒí•˜ëŠ” ê²½ìš°

```java
public class ObservableSet<E> extends ForwardingSet<E>{
    public ObservableSet(Set<E> set) {
        super(set);
    }

    private final List<SetObserver<E>> observers = new ArrayList<>();

    public void addObserver(SetObserver<E> observer){
        synchronized (observers){
            observers.add(observer);
        }
    }
		// ì™¸ê³„ì¸ ë©”ì„œë“œ
    private void notifyElementAdded(E element){
        synchronized (observers){
            for(SetObserver observer: observers){
                observer.added(this,element);
            }
        }
    }

    public boolean removeObserver(SetObserver<E> observer){
        synchronized (observers){
            return observers.remove(observer);
        }
    }

    @Override
    public boolean add(E element) {
        boolean added = super.add(element);
        if(added)notifyElementAdded(element);
        return added;
    }

    public static void main(String[] args) {
        ObservableSet<Integer> set = new ObservableSet<>(new HashSet<>());

//        set.addObserver(((set1, element) -> System.out.println(element)));
//
//        for (int i = 0; i < 100; i++) {
//            set.add(i);
//        }// 100ê¹Œì§€ ì¶œë ¥

				// 23 ì¼ ë•Œ , ì§€ìš°ëŠ” ì¡°ê±´ ì¶”ê°€
        set.addObserver(new SetObserver<Integer>() {
            @Override
            public void added(ObservableSet<Integer> set, Integer element) {
                System.out.println(element);
                if (element == 23)
                    set.removeObserver(this);
            }
        });
        for (int i = 0; i < 100; i++) {
            set.add(i);
        }
    }

}
```

```java
@FunctionalInterface
public interface SetObserver<E> {

    void added(ObservableSet<E> set, E element);
}
```

case2) ì“¸ë° ì—†ì´ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•˜ëŠ” ê´€ì°°ì(êµì°© ìƒíƒœ)

```java
set.addObserver(new SetObserver<>() {
    public void added(ObservableSet<Integer> s, Integer e) {
        System.out.println(e);
        if(e == 23) {
            ExecutorService exec = Executors.newSingleThreadExecutor();
            try {
                exec.submit(() -> s.removeObserver(this)).get(); //ì—¬ê¸°ì„œ lock
               													 //í•˜ì§€ë§Œ ë©”ì¸ ìŠ¤ë ˆë“œ ì‘ì—…ì„ ê¸°ë‹¤ë¦¼ 
            } catch(ExecutionException | InterruptedException ex) {
                throw new AssertionError(ex);
            } finally {
                exec.shutdown();
            }
        }
    }
}); 
```

### ë½ì˜ ì¬ì§„ì…

ë½ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª… â†’[https://parkcheolu.tistory.com/2](https://parkcheolu.tistory.com/24)4

ìë°”ì˜ ê³ ìœ  ë½ì€ ì¬ì§„ì… ê°€ëŠ¥í•˜ë‹¤. ì¬ì§„ì… ê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒì€ ë½ì˜ íšë“ì´ í˜¸ì¶œ ë‹¨ìœ„ê°€ ì•„ë‹Œ ìŠ¤ë ˆë“œ ë‹¨ìœ„ë¡œ ì¼ì–´ë‚œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤. ì´ë¯¸ ë½ì„ íšë“í•œ ìŠ¤ë ˆë“œëŠ” ê°™ì€ ë½ì„ ì–»ê¸° ìœ„í•´ ëŒ€ê¸°í•  í•„ìš” ì—†ë‹¤.

```java
public class Reentrancy {
  public synchronized void a() {
    System.out.println("a");
    // bê°€ synchronizedë¡œ ì„ ì–¸ë˜ì–´ ìˆì§€ë§Œ aì§„ì…ì‹œ ì´ë¯¸ ë½ì„ íšë“í•˜ì˜€ìœ¼ë¯€ë¡œ,
    // bë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆë‹¤.
    b();
  }
  public synchronized void b() {
    System.out.println("b");
  }
  public static void main(String[] args) {
    new Reentrancy().a();
  }
}
```

ë§Œì•½ ì¬ì§„ì…ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤ë©´? â†’ êµì°© ìƒíƒœì— ë¹ ì§ˆê²ƒ

### ë¬¸ì œì 

ì•ˆì „ì‹¤íŒ¨ (ë°ì´í„° ë³€ëª¨)ì˜ ë¬¸ì œ

êµì°© ìƒíƒœëŠ” ë§‰ì„ ìˆ˜ ìˆì§€ë§Œ, ê°™ì€ ë½ì—ì„œ ë³´í˜¸ ë°›ê³  ìˆëŠ” ë°ì´í„°ì— ëŒ€í•´ ê°œë…ì ìœ¼ë¡œ ê´€ë ¨ì´ ì—†ëŠ” ë‹¤ë¥¸ ì‘ì—…ì´ ì§„í–‰ ì¤‘ì´ì–´ë„ ë½ íšë“ì„ ì„±ê³µí•œë‹¤.

ê·¸ëŸ¬ë¯€ë¡œ ë°ì´í„°ì˜ í›¼ì†ê°€ëŠ¥ì„±ì´ ì¦ê°€í•œë‹¤.

ë½ì˜ ì¬ì§„ì… ë¬¸ì œ í•´ê²° ë°©ë²• -1)

```java
private void notifyElementAdded(E element) {
    List<SetObserver<E>> snapshot = null;
    synchronized(observers) {
        snapshot = new ArrayList<>(observers);
    }
    for (SetObserver<E> observer : snapshot) {
        observer.added(this, element); //ë™ê¸°í™” ë¸”ë¡ ë°”ê¹¥ìœ¼ë¡œ
    }
}
```

ë½ì˜ ì¬ì§„ì… ë¬¸ì œ í•´ê²° ë°©ë²• 2)

ìë°”ì˜ ë™ì‹œì„± ì»¬ë ‰ì…˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ CopyOnWriteArrayList ë¥¼ í™œìš©

ë‚´ë¶€ë¥¼ ë³€ê²½í•˜ëŠ” ì‘ì—…ì€ í•­ìƒ ë³µì‚¬ë³¸ì„ ë§Œë“¤ì–´ ìˆ˜í–‰ 

ë‚´ë¶€ì˜ ë°°ì—´ì€ ìˆ˜ì •ë˜ì§€ ì•Šì•„ì„œ ìˆœíšŒí•  ë•Œ ë½ì´ í•„ìš” ì—†ë‹¤.

```java
private final List<SetObserser<E>> observers = new CopyOnWriteArrayList<>();

public void notifyElementAdded(E element) {
    for (SetObserver<E> observer : observers) {
         observers.added(this, element);
    }
}
```

---

## ë™ê¸°í™”ì˜ ì„±ëŠ¥

ìë°”ì˜ ë™ê¸°í™” ë¹„ìš©ì€ ë¹ ë¥´ê²Œ ë‚®ì•„ì ¸ ì™”ì§€ë§Œ, ê³¼ë„í•œ ë™ê¸°í™”ë¥¼ í”¼í•˜ëŠ”ì¼ì€ ì˜¤íˆë ¤ ê³¼ê±° ì–´ëŠ ë•Œë³´ë‹¤ ì¤‘ìš”í•˜ë‹¤.

ë©€í‹°ì½”ì–´ê°€ ì¼ë°˜í™”ëœ ì˜¤ëŠ˜ë‚  ê³¼ë„í•œ ë™ê¸°í™”ê°€ ì´ˆë˜í•˜ëŠ” ì§„ì§œ ë¹„ìš©ì€ ë½ì„ ì–»ëŠ”ë° ë“œëŠ” CPU ì‹œê°„ì´ ì•„ë‹ˆë‹¤.

ì„œë¡œ ìŠ¤ë ˆë“œë¼ë¦¬ ê²½ìŸí•˜ëŠ” Race Conditionì— ë‚­ë¹„ê°€ ë°œìƒí•œë‹¤.

- ë³‘ë ¬ë¡œ ì‹¤í–‰í•  ê¸°íšŒë¥¼ ìƒëŠ”ë‹¤.
- ëª¨ë“  ì½”ì–´ê°€ ë©”ëª¨ë¦¬ë¥¼ ì¼ê´€ë˜ê²Œ ë³´ê¸°ìœ„í•œ ì§€ì—°ì‹œê°„ì´ ì§„ì§œ ë¹„ìš©
- ê°€ìƒë¨¸ì‹ ì˜ ì½”ë“œìµœì í™”ë¥¼ ì œí•œí•˜ëŠ” ì ë„ ìˆ¨ì€ ë¹„ìš©

---

## ì •ë¦¬

- ê¸°ë³¸ ê·œì¹™ì€ ë™ê¸°í™” ì˜ì—­ì—ì„œ ê°€ëŠ¥í•œ í•œ ì¼ì„ ì ê²Œí•˜ëŠ” ê²ƒ
- ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì‘ì—…ì´ë¼ë©´ ë™ê¸°í™” ì˜ì—­ ë°–ìœ¼ë¡œ ì˜®ê¸°ëŠ” ë°©ë²•ì„ ì°¾ì•„ë³´ì.
- ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ í˜¸ì¶œí•  ê°€ëŠ¥ì„±ì´ ìˆëŠ” ë©”ì„œë“œê°€ ì •ì  í•„ë“œë¥¼ ìˆ˜ì •í•œë‹¤ë©´ ê·¸ í•„ë“œë¥¼ ì‚¬ìš©í•˜ê¸° ì „ì— ë°˜ë“œì‹œ ë™ê¸°í™” í•´ì•¼ í•œë‹¤.
- êµì°©ìƒíƒœì™€ ë°ì´í„° í›¼ì†ì„ í”¼í•˜ë ¤ë©´ ë™ê¸°í™” ì˜ì—­ ì•ˆì—ì„œ ì™¸ê³„ì¸ ë©”ì„œë“œë¥¼ ì ˆëŒ€ í˜¸ì¶œí•˜ì§€ ë§ì
- ë™ê¸°í™” ì˜ì—­ ì•ˆì—ì„œ ì‘ì—…ì€ ìµœì†Œí•œìœ¼ë¡œ ì¤„ì´ì
